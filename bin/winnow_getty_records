#!/usr/bin/env ruby

##
# The raw dump of Getty records contains many that
# are not part of the Cicognara Collection.  This
# script winnows out the unnecessary records non-
# destructively, by copying only the relevant files
# to the "tmp/cicorecords" directory.
##

require "fileutils"
require "logger"
require "nokogiri"

def is_cico(node)
  tokens = node.text.gsub(' ', '').split(';')
  return false unless tokens.any? { |tok| tok =~/^cico:/}
  ids = tokens.collect { |tok| tok.split(':').last }
  # There are records with invalid cicognara numbers.
  # Reject records with these identifiers.
  return ids.all? { |i| i =~ /^\d/ }
end

sourcedir = "#{File.dirname(__FILE__)}/../tmp/resources"
targetdir = "#{File.dirname(__FILE__)}/../tmp/cicorecords"


logger = Logger.new(STDOUT)
records = []

FileUtils.mkdir_p targetdir

log = Logger.new(STDOUT)
number_kept_files = 0

Dir["#{sourcedir}/*.xml"].each do |file|
  record = Nokogiri::XML(File.read(file))

  ids = record.xpath('//dc:identifier')
  has_cico = ids.any? { |id| is_cico(id) }

  collections = record.xpath('//dcterms:isPartOf')
  in_collection = collections.any?{ |c| c.text == "Cicognara Collection"}

  hasFormat = record.xpath('//dcterms:hasFormat')

  has_manifest = hasFormat.length > 0

  if has_cico and in_collection and has_manifest
    number_kept_files += 1
    log.info("keeping #{file}")
    FileUtils.cp file, targetdir
  end
end

log.info("kept #{number_kept_files} files")
