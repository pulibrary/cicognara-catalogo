#!/usr/bin/env ruby

##
# The raw dump of Getty records contains many that are not part of the
# Cicognara Collection.  This script winnows out the unnecessary
# records, keeping only files that have cico numbers, a manifest, and
# are part of the Cicognara Collection.

require "fileutils"
require "logger"
require "nokogiri"

def is_cico(node)
  tokens = node.text.gsub(' ', '').split(';')
  return false unless tokens.any? { |tok| tok =~/^cico:/}
  ids = tokens.collect { |tok| tok.split(':').last }
  # There are records with invalid cicognara numbers.
  # Reject records with these identifiers.
  return ids.all? { |i| i =~ /^\d/ }
end

sourcedir = "#{File.dirname(__FILE__)}/../tmp/resources"

Dir["#{sourcedir}/*.xml"].each do |file|
  record = Nokogiri::XML(File.read(file))

  has_cico = record.xpath('//dc:identifier').any? { |id|
    is_cico(id)
  }

  in_collection = record.xpath('//dcterms:isPartOf').any?{ |c|
    c.text == "Cicognara Collection"
  }

  has_manifest = record.xpath('//dcterms:hasFormat').length > 0

  FileUtils.remove_file file unless
    has_cico and in_collection and has_manifest
end
